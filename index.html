<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flanker Task</title>
    <style>
        /* Basic CSS - Consider adding more specific styles for the form */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 700px;
            padding: 30px;
            border: 1px solid #ccc;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #stimulus, #fixation {
            font-size: 80px;
            font-family: 'Courier New', Courier, monospace;
            margin: 40px 0;
            height: 90px;
            line-height: 90px;
            color: #333;
        }
        #fixation { font-size: 50px; }
        button {
            padding: 12px 24px;
            font-size: 18px;
            margin-top: 25px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        button:hover { background-color: #0056b3; }
        .hidden { display: none; }
        #summary ul, #instructions ul, #participantInfo form {
             display: inline-block;
             text-align: left;
             margin-top: 15px;
             margin-bottom: 15px;
        }
         #summary li, #instructions li, #participantInfo label, #participantInfo input, #participantInfo select {
             margin-bottom: 10px; /* Spacing for form/list items */
             display: block; /* Make form elements block for vertical layout */
             font-size: 16px;
        }
         #participantInfo input, #participantInfo select {
             padding: 8px;
             margin-left: 5px; /* Align inputs slightly */
             min-width: 150px;
         }
         #participantInfo label {
             font-weight: bold;
         }
        #feedback { font-size: 24px; font-weight: bold; margin-top: 15px; height: 30px; }
        .correct { color: green; }
        .incorrect { color: red; }
        .error-message { color: red; font-size: 14px; margin-top: 10px; }
        #developerDataButton { background-color: #6c757d; margin-left: 15px; } /* Style for download button */
        #developerDataButton:hover { background-color: #5a6268; }
    </style>
</head>
<body>
    <div class="container">
        <div id="instructions">
             <h2>Welcome to the Flanker Task</h2>
             <p>Please read the instructions carefully.</p>
             <p>You will first be asked for some basic information.</p>
             <p>Then, a sequence of letters will appear after a '+' sign.</p>
             <p>Your task is to identify the <strong>center letter</strong> and ignore the surrounding letters.</p>
             <ul>
                 <li>Press <strong>F</strong> if the center letter is <strong>A</strong></li>
                 <li>Press <strong>J</strong> if the center letter is <strong>L</strong></li>
             </ul>
             <p>Please respond as quickly and accurately as possible.</p>
             <p>Click "Continue" to enter your information.</p>
             <button id="continueToInfoBtn">Continue</button>
        </div>

        <div id="participantInfo" class="hidden">
            <h2>Participant Information</h2>
            <form id="infoForm">
                <label for="participantId">Participant ID (5 digits):</label>
                <input type="text" id="participantId" name="participantId" pattern="\d{5}" required maxlength="5" title="Enter exactly 5 digits">

                <label for="age">Age:</label>
                <input type="number" id="age" name="age" required min="1" max="120">

                <label for="gender">Gender:</label>
                <select id="gender" name="gender" required>
                    <option value="">--Please select--</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Other">Other</option>
                    <option value="Prefer_not_to_say">Prefer not to say</option>
                </select>
                <button type="submit" id="startTaskBtn">Start Task</button>
                 <div id="infoError" class="error-message hidden">Please fill out all fields correctly.</div>
            </form>
        </div>


        <div id="task" class="hidden">
            <div id="fixation">+</div>
            <div id="stimulus" class="hidden"></div>
            <div id="feedback" class="hidden"></div>
        </div>

        <div id="summary" class="hidden">
            <h2>Task Complete!</h2>
            <p>Here is a summary of your results:</p>
            <div id="summaryResults">
                 </div>
            <button id="restartBtn">Restart Task</button>
            <button id="developerDataButton">Download Raw Data (JSON)</button> </div>
    </div>

    <script>
        // --- Get References to HTML Elements ---
        const continueToInfoBtn = document.getElementById('continueToInfoBtn');
        const instructionsDiv = document.getElementById('instructions');
        const participantInfoDiv = document.getElementById('participantInfo');
        const infoForm = document.getElementById('infoForm');
        const participantIdInput = document.getElementById('participantId');
        const ageInput = document.getElementById('age');
        const genderInput = document.getElementById('gender');
        const startTaskBtn = document.getElementById('startTaskBtn');
        const infoErrorDiv = document.getElementById('infoError');

        const taskDiv = document.getElementById('task');
        const fixationDiv = document.getElementById('fixation');
        const stimulusDiv = document.getElementById('stimulus');
        const feedbackDiv = document.getElementById('feedback');
        const summaryDiv = document.getElementById('summary');
        const summaryResultsDiv = document.getElementById('summaryResults');
        const restartBtn = document.getElementById('restartBtn');
        const developerDataButton = document.getElementById('developerDataButton');


        // --- Task State Variables ---
        let trials = [];
        let currentTrialIndex = 0;
        let results = []; // Will store raw trial data
        let summaryMetrics = {}; // Will store calculated summary metrics
        let participantData = {}; // To store ID, age, gender
        let stimulusStartTime;
        let responseListener = null;

        // --- Timing Parameters (in milliseconds) ---
        const FIXATION_DURATION = 500;
        const FEEDBACK_DURATION = 750;
        const ITI = 500; // Inter-trial interval

        // --- Utility: Shuffle Array ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

         // --- Utility: Calculate Standard Deviation ---
         function calculateSD(data, mean) {
             if (!data || data.length === 0) return 0;
             const variance = data.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / data.length;
             return Math.sqrt(variance);
         }

        // --- Define the Trials (100 trials) ---
        function setupTrials() {
            const stimuli = {
                congruentA: { stimulus: 'AAAAA', correctKey: 'f', condition: 'congruent' },
                congruentL: { stimulus: 'LLLLL', correctKey: 'j', condition: 'congruent' },
                incongruentA: { stimulus: 'LLALL', correctKey: 'f', condition: 'incongruent' }, // Center A -> press F
                incongruentL: { stimulus: 'AALAA', correctKey: 'j', condition: 'incongruent' }  // Center L -> press J
            };

            const baseTrials = [];
            const trialsPerType = 25; // 25 * 4 = 100 trials

            for (let i = 0; i < trialsPerType; i++) {
                baseTrials.push({...stimuli.congruentA});
                baseTrials.push({...stimuli.congruentL});
                baseTrials.push({...stimuli.incongruentA});
                baseTrials.push({...stimuli.incongruentL});
            }

            trials = shuffleArray(baseTrials);
            currentTrialIndex = 0;
            results = [];
            console.log(`Setup complete: ${trials.length} trials generated.`);
        }

        // --- Start Experiment Flow ---
        function startExperiment() {
            console.log("Starting experiment for participant:", participantData);
            setupTrials();
            if (trials.length > 0) {
                runTrial(currentTrialIndex);
            } else {
                console.error("No trials defined!");
            }
        }

        // --- Run a Single Trial ---
        function runTrial(trialIndex) {
            if (trialIndex >= trials.length) {
                endExperiment();
                return;
            }
            // console.log(`Running trial ${trialIndex + 1}/${trials.length}`); // Less console noise
            const currentTrial = trials[trialIndex];

            taskDiv.classList.remove('hidden');
            stimulusDiv.classList.add('hidden');
            feedbackDiv.classList.add('hidden');
            fixationDiv.classList.remove('hidden');
            fixationDiv.textContent = '+';

            setTimeout(() => {
                fixationDiv.classList.add('hidden');
                stimulusDiv.textContent = currentTrial.stimulus;
                stimulusDiv.classList.remove('hidden');
                stimulusStartTime = performance.now();

                if (responseListener) {
                   document.removeEventListener('keydown', responseListener);
                }
                responseListener = (event) => handleKeyPress(event, currentTrial);
                document.addEventListener('keydown', responseListener);

            }, FIXATION_DURATION);
        }

        // --- Handle Key Press ---
        function handleKeyPress(event, trial) {
            const key = event.key.toLowerCase();
            if (key === 'f' || key === 'j') {
                 const reactionTime = performance.now() - stimulusStartTime;
                 const correct = key === trial.correctKey;

                 document.removeEventListener('keydown', responseListener);
                 responseListener = null;
                 stimulusDiv.classList.add('hidden');

                 // Store detailed raw data for this trial
                 results.push({
                     participantId: participantData.id,
                     age: participantData.age,
                     gender: participantData.gender,
                     trialIndex: currentTrialIndex,
                     stimulus: trial.stimulus,
                     condition: trial.condition,
                     response: key,
                     correctKey: trial.correctKey,
                     correct: correct ? 1 : 0, // Store as 1 or 0
                     rt: reactionTime
                 });

                 showFeedback(correct);

                 setTimeout(() => {
                     currentTrialIndex++;
                     runTrial(currentTrialIndex);
                 }, FEEDBACK_DURATION + ITI);
            }
        }

        // --- Show Feedback ---
        function showFeedback(correct) {
            feedbackDiv.classList.remove('hidden');
            if (correct) {
                feedbackDiv.textContent = "Correct";
                feedbackDiv.className = 'correct';
            } else {
                feedbackDiv.textContent = "Incorrect";
                feedbackDiv.className = 'incorrect';
            }
        }

        // --- End Experiment and Calculate Metrics ---
        function endExperiment() {
            console.log("Experiment ended. Calculating metrics...");
            taskDiv.classList.add('hidden');

            // --- Calculations ---
            let correctCount = 0;
            let totalCorrectRT = 0;
            let correctRTs = []; // Array for overall SD calculation

            let congruentCorrectCount = 0;
            let incongruentCorrectCount = 0;
            let congruentTotal = 0;
            let incongruentTotal = 0;
            let congruentCorrectRTtotal = 0;
            let incongruentCorrectRTtotal = 0;
            let congruentCorrectRTs = []; // Array for congruent SD
            let incongruentCorrectRTs = []; // Array for incongruent SD

            results.forEach(res => {
                if (res.condition === 'congruent') congruentTotal++;
                if (res.condition === 'incongruent') incongruentTotal++;

                if (res.correct === 1) {
                    correctCount++;
                    totalCorrectRT += res.rt;
                    correctRTs.push(res.rt);

                    if (res.condition === 'congruent') {
                        congruentCorrectCount++;
                        congruentCorrectRTtotal += res.rt;
                        congruentCorrectRTs.push(res.rt);
                    } else if (res.condition === 'incongruent') {
                        incongruentCorrectCount++;
                        incongruentCorrectRTtotal += res.rt;
                        incongruentCorrectRTs.push(res.rt);
                    }
                }
            });

            const totalTrials = results.length;
            const overallAccuracy = totalTrials > 0 ? (correctCount / totalTrials) * 100 : 0;
            const overallMeanRT = correctCount > 0 ? (totalCorrectRT / correctCount) : 0;
            const overallSDRT = calculateSD(correctRTs, overallMeanRT);
            const errorRate = 100 - overallAccuracy;

            const congruentAccuracy = congruentTotal > 0 ? (congruentCorrectCount / congruentTotal) * 100 : 0;
            const incongruentAccuracy = incongruentTotal > 0 ? (incongruentCorrectCount / incongruentTotal) * 100 : 0;

            const congruentMeanRT = congruentCorrectCount > 0 ? (congruentCorrectRTtotal / congruentCorrectCount) : 0;
            const incongruentMeanRT = incongruentCorrectCount > 0 ? (incongruentCorrectRTtotal / incongruentCorrectCount) : 0;

            const congruentSDRT = calculateSD(congruentCorrectRTs, congruentMeanRT);
            const incongruentSDRT = calculateSD(incongruentCorrectRTs, incongruentMeanRT);

            // Flanker Interference Effects
            const interferenceRT = (congruentMeanRT > 0 && incongruentMeanRT > 0) ? (incongruentMeanRT - congruentMeanRT) : 'N/A';
            const interferenceAccuracy = (congruentAccuracy - incongruentAccuracy);

            // Store calculated metrics
            summaryMetrics = {
                totalTrials: totalTrials,
                overallAccuracy: overallAccuracy.toFixed(2),
                overallMeanRT_ms: overallMeanRT.toFixed(2),
                overallSDRT_ms: overallSDRT.toFixed(2),
                errorRate: errorRate.toFixed(2),
                congruentTotal: congruentTotal,
                congruentAccuracy: congruentAccuracy.toFixed(2),
                congruentMeanRT_ms: congruentMeanRT.toFixed(2),
                congruentSDRT_ms: congruentSDRT.toFixed(2),
                incongruentTotal: incongruentTotal,
                incongruentAccuracy: incongruentAccuracy.toFixed(2),
                incongruentMeanRT_ms: incongruentMeanRT.toFixed(2),
                incongruentSDRT_ms: incongruentSDRT.toFixed(2),
                interferenceRT_ms: typeof interferenceRT === 'number' ? interferenceRT.toFixed(2) : interferenceRT,
                interferenceAccuracy: interferenceAccuracy.toFixed(2)
            };

            console.log("Summary Metrics:", summaryMetrics);

            // Display summary to participant
            summaryResultsDiv.innerHTML = `
                <ul>
                    <li>Overall Accuracy: ${summaryMetrics.overallAccuracy}%</li>
                    <li>Average Correct Reaction Time: ${summaryMetrics.overallMeanRT_ms} ms</li>
                    <li>Reaction Time Interference (Incongruent - Congruent): ${summaryMetrics.interferenceRT_ms} ms</li>
                    <li>Accuracy Interference (Congruent - Incongruent): ${summaryMetrics.interferenceAccuracy}%</li>
                </ul>
            `;
            summaryDiv.classList.remove('hidden');
        }

        // --- Function to trigger JSON download ---
        function downloadData() {
            const dataStr = JSON.stringify({
                participantInfo: participantData,
                summaryMetrics: summaryMetrics,
                rawData: results
            }, null, 2); // Pretty print JSON

            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');

            // Create filename with ID and timestamp
             const date = new Date();
             const timestamp = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}${String(date.getSeconds()).padStart(2, '0')}`;
             a.download = `flanker_results_${participantData.id}_${timestamp}.json`;
            a.href = url;
            document.body.appendChild(a); // Append anchor to body
            a.click(); // Simulate click to trigger download
            document.body.removeChild(a); // Clean up anchor
            URL.revokeObjectURL(url); // Release object URL
            console.log("Data download initiated.");
        }


        // --- Event Listeners ---

        // Instructions -> Participant Info
        continueToInfoBtn.addEventListener('click', () => {
             instructionsDiv.classList.add('hidden');
             participantInfoDiv.classList.remove('hidden');
        });

        // Participant Info Form Submission -> Start Task
        infoForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default form submission
            const id = participantIdInput.value;
            const age = ageInput.value;
            const gender = genderInput.value;

            // Basic Validation
            if (id.match(/^\d{5}$/) && age && gender) {
                participantData = {
                    id: id,
                    age: parseInt(age), // Store age as number
                    gender: gender
                };
                infoErrorDiv.classList.add('hidden'); // Hide error message
                participantInfoDiv.classList.add('hidden'); // Hide form
                startExperiment(); // Start the actual task
            } else {
                infoErrorDiv.textContent = "Please ensure ID is 5 digits and all fields are filled.";
                infoErrorDiv.classList.remove('hidden'); // Show error message
            }
        });

        // Restart Button
        restartBtn.addEventListener('click', () => {
            summaryDiv.classList.add('hidden');
            // Show instructions again for a full restart loop
            instructionsDiv.classList.remove('hidden');
            // Clear participant data? Or go straight to info form? Let's go to info form.
            // participantInfoDiv.classList.remove('hidden'); // <-- Option to restart from info form
            // infoForm.reset(); // Clear previous entries
        });

        // Developer Data Download Button
        developerDataButton.addEventListener('click', downloadData);


    </script>
</body>
</html>
