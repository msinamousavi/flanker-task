<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flanker Task (Touch Added)</title>
    <style>
        /* Basic CSS */
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f8f9fa; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; overscroll-behavior-y: contain; }
        .container { max-width: 700px; padding: 30px; border: 1px solid #ccc; background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #task { position: relative; }
        #stimulus, #fixation { font-size: 80px; font-family: 'Courier New', Courier, monospace; margin: 40px 0; height: 90px; line-height: 90px; color: #333; white-space: pre; }
        #fixation { font-size: 50px; }
        #noiseOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle, rgba(0,0,0,0.12) 1px, transparent 1px); background-size: 3px 3px; opacity: 0.7; pointer-events: none; z-index: 10; }
        button { padding: 12px 24px; font-size: 18px; margin-top: 25px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background-color 0.2s ease; }
        button:hover { background-color: #0056b3; }
        .hidden { display: none; }
        #summary ul, #instructions ul, #participantInfo form { display: inline-block; text-align: left; margin-top: 15px; margin-bottom: 15px; }
        #summary li, #instructions li { margin-bottom: 8px; font-size: 16px; }
        #participantInfo label, #participantInfo input, #participantInfo select { margin-bottom: 10px; display: block; font-size: 16px; }
        #participantInfo input, #participantInfo select { padding: 10px; margin-left: 5px; min-width: 150px; box-sizing: border-box; width: calc(100% - 10px); } /* Easier tap */
        #participantInfo label { font-weight: bold; margin-top: 10px; }
        #feedback { font-size: 24px; font-weight: bold; margin-top: 15px; height: 30px; }
        .correct { color: green; }
        .incorrect { color: red; }
        .error-message { color: red; font-size: 14px; margin-top: 10px; }
        #developerDataButton { background-color: #28a745; margin-left: 15px; }
        #developerDataButton:hover { background-color: #218838; }

        /* <<< Step 4: CSS for Touch Buttons >>> */
        #touchResponses { margin-top: 25px; display: flex; justify-content: space-around; align-items: center; width: 100%; }
        .responseBtn { padding: 20px 10px; font-size: 18px; font-weight: bold; width: 45%; min-height: 80px; cursor: pointer; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; line-height: 1.3; background-color: #6c757d; color: white; border: none; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .responseBtn:hover, .responseBtn:active { background-color: #5a6268; }
        /* Basic responsiveness */
         @media (max-width: 720px) { .container { max-width: 95vw; padding: 15px;} #stimulus { font-size: calc(10vw + 20px); height: auto; line-height: 1.2; margin: 20px 0;} #fixation { font-size: calc(8vw + 15px); height: auto; line-height: 1.2; margin: 20px 0;} button { font-size: 16px; padding: 10px 15px; } .responseBtn { font-size: 16px; width: 48%; min-height: 70px;} #touchResponses { margin-top: 20px; } }
         @media (max-width: 480px) { #stimulus { font-size: calc(12vw + 15px); margin: 15px 0;} #fixation { font-size: calc(10vw + 10px); margin: 15px 0;} .responseBtn { font-size: 14px; width: 47%; min-height: 65px; padding: 15px 5px;} }
    </style>
</head>
<body>
    <div class="container">
        <div id="instructions">
            <h2>Welcome to the Flanker Task</h2>
            {/* ... intro paragraphs ... */}
            <p>Your task is to identify the <strong>center letter</strong> and ignore the surrounding letters and any noise or spacing.</p>
             {/* <<< Step 6: Updated Instructions >>> */}
             <ul id="instructionList">
                  <li>If center is <strong>A</strong> or <strong>K</strong>: Press <strong>F</strong> or Tap <strong>Left Button</strong></li>
                  <li>If center is <strong>L</strong> or <strong>R</strong>: Press <strong>J</strong> or Tap <strong>Right Button</strong></li>
             </ul>
             <p>Please respond as quickly and accurately as possible (1.5s limit).</p> {/* Combined timeout message */}
             <p>Click "Continue" to enter your information.</p>
            <button id="continueToInfoBtn">Continue</button>
        </div>

        <div id="participantInfo" class="hidden"> /* ... form ... */ </div>

        <div id="task" class="hidden">
            <div id="noiseOverlay" class="hidden"></div>
            <div id="fixation">+</div>
            <div id="stimulus" class="hidden"></div>
            <div id="feedback" class="hidden"></div>
            {/* <<< Step 3: Added Touch Response Buttons HTML >>> */}
            <div id="touchResponses" class="hidden">
                <button id="touchBtnF" class="responseBtn">A / K<br>(Tap Left)</button>
                <button id="touchBtnJ" class="responseBtn">L / R<br>(Tap Right)</button>
            </div>
        </div>

        <div id="summary" class="hidden"> /* ... summary results div and buttons ... */ </div>
    </div>

    <script>
        // --- References (Added touch elements) ---
        const continueToInfoBtn = document.getElementById('continueToInfoBtn');
        const instructionsDiv = document.getElementById('instructions');
        const participantInfoDiv = document.getElementById('participantInfo');
        const infoForm = document.getElementById('infoForm');
        const participantIdInput = document.getElementById('participantId');
        const ageInput = document.getElementById('age');
        const genderInput = document.getElementById('gender');
        const startTaskBtn = document.getElementById('startTaskBtn');
        const infoErrorDiv = document.getElementById('infoError');
        const taskDiv = document.getElementById('task');
        const fixationDiv = document.getElementById('fixation');
        const stimulusDiv = document.getElementById('stimulus');
        const feedbackDiv = document.getElementById('feedback');
        const noiseOverlay = document.getElementById('noiseOverlay');
        const summaryDiv = document.getElementById('summary');
        const summaryResultsDiv = document.getElementById('summaryResults');
        const restartBtn = document.getElementById('restartBtn');
        const developerDataButton = document.getElementById('developerDataButton');
        // <<< Added touch button references >>>
        const touchResponseDiv = document.getElementById('touchResponses');
        const touchBtnF = document.getElementById('touchBtnF');
        const touchBtnJ = document.getElementById('touchBtnJ');


        // --- State (Added listener variables) ---
        let trials = [];
        let currentTrialIndex = 0;
        let results = [];
        let summaryMetrics = {};
        let participantData = {};
        let stimulusStartTime;
        let experimentStartTime;
        let keydownListener = null; // Changed from responseListener
        let touchFListener = null;  // <<< Added
        let touchJListener = null;  // <<< Added
        let trialTimeoutId = null;

        // --- Config (Unaltered) ---
        const FIXATION_DURATION = 500;
        const FEEDBACK_DURATION = 750;
        const ITI = 500;
        const MAX_RESPONSE_TIME = 1500;

        // --- Utilities (Unaltered) ---
        function shuffleArray(array) { /* ... */ }
        function calculateSD(data, mean) { /* ... */ }
        function calculateMedian(data) { /* ... */ }
        function formatStimulusWithSpacing(stimulusString, spacingType) { /* ... */ }

        // --- Trial Setup (Unaltered) ---
        function setupTrials() { /* ... */ }

        // --- Experiment Flow (Unaltered) ---
        function startExperiment() { /* ... */ }

        // --- <<< NEW Helper to remove touch listeners >>> ---
        function removeTouchListeners() {
            if (touchFListener) {
                touchBtnF.removeEventListener('touchstart', touchFListener);
                touchFListener = null;
            }
            if (touchJListener) {
                touchBtnJ.removeEventListener('touchstart', touchJListener);
                touchJListener = null;
            }
        }

        // --- Run a Single Trial (Modified to ADD touch listeners) ---
        function runTrial(trialIndex) {
            if (trialIndex >= trials.length) { endExperiment(); return; }
            const currentTrial = trials[trialIndex];

            if (trialTimeoutId) clearTimeout(trialTimeoutId); // Clear previous timeout
            if (keydownListener) document.removeEventListener('keydown', keydownListener); // Clear previous keyboard listener
            removeTouchListeners(); // Clear previous touch listeners

            taskDiv.classList.remove('hidden');
            stimulusDiv.classList.add('hidden');
            feedbackDiv.classList.add('hidden');
            noiseOverlay.classList.add('hidden');
            touchResponseDiv.classList.add('hidden'); // Hide touch buttons initially
            fixationDiv.textContent = '+';
            fixationDiv.classList.remove('hidden');

            setTimeout(() => {
                try {
                    fixationDiv.classList.add('hidden');
                    const formattedStimulus = formatStimulusWithSpacing(currentTrial.stimulus_base, currentTrial.condition_spacing);
                    stimulusDiv.innerHTML = formattedStimulus;
                    stimulusDiv.classList.remove('hidden');
                    if (currentTrial.condition_noise === 'yes') { noiseOverlay.classList.remove('hidden'); }
                    stimulusStartTime = performance.now();

                    // Add keyboard listener (as before)
                    keydownListener = (event) => handleKeyPress(event, currentTrial);
                    document.addEventListener('keydown', keydownListener);

                    // <<< Add Touch Listeners >>>
                    touchResponseDiv.classList.remove('hidden'); // Show buttons
                    touchFListener = (event) => {
                        event.preventDefault(); // Prevent zoom/scroll etc.
                        console.log("Touch F triggered for trial", currentTrialIndex);
                        // Check if already processed (race condition safety)
                         if(results.some(r => r.trialIndex === currentTrialIndex)) return;
                        if(trialTimeoutId) clearTimeout(trialTimeoutId); // Clear timeout
                        trialTimeoutId = null;
                        removeTouchListeners(); // Remove touch listeners
                         if (keydownListener) { // Remove keyboard listener too
                             document.removeEventListener('keydown', keydownListener);
                             keydownListener = null;
                         }
                         // --- Replicated core logic from handleKeyPress for 'f' ---
                         const reactionTime = performance.now() - stimulusStartTime;
                         let expectedKey; const centerLower = currentTrial.centerLetter.toLowerCase();
                         if (['a', 'k'].includes(centerLower)) expectedKey = 'f'; else if (['l', 'r'].includes(centerLower)) expectedKey = 'j'; else expectedKey = '?';
                         const correct = 'f' === expectedKey;
                         stimulusDiv.classList.add('hidden'); noiseOverlay.classList.add('hidden'); touchResponseDiv.classList.add('hidden');
                         results.push({ participantId: participantData.id, age: participantData.age, gender: participantData.gender, trialIndex: currentTrialIndex, stimulus: currentTrial.stimulus_base, centerLetter: currentTrial.centerLetter, congruency: currentTrial.condition_congruency, noise: currentTrial.condition_noise, spacing: currentTrial.condition_spacing, response: 'f', correctKey: expectedKey, correct: correct ? 1 : 0, latency_ms: reactionTime });
                         showFeedback(correct ? "Correct" : "Incorrect");
                         setTimeout(() => { currentTrialIndex++; runTrial(currentTrialIndex); }, FEEDBACK_DURATION + ITI);
                         // --- End Replicated Logic ---
                    };
                    touchJListener = (event) => {
                        event.preventDefault();
                        console.log("Touch J triggered for trial", currentTrialIndex);
                         // Check if already processed
                         if(results.some(r => r.trialIndex === currentTrialIndex)) return;
                        if(trialTimeoutId) clearTimeout(trialTimeoutId); // Clear timeout
                        trialTimeoutId = null;
                        removeTouchListeners(); // Remove touch listeners
                         if (keydownListener) { // Remove keyboard listener too
                             document.removeEventListener('keydown', keydownListener);
                             keydownListener = null;
                         }
                        // --- Replicated core logic from handleKeyPress for 'j' ---
                         const reactionTime = performance.now() - stimulusStartTime;
                         let expectedKey; const centerLower = currentTrial.centerLetter.toLowerCase();
                         if (['a', 'k'].includes(centerLower)) expectedKey = 'f'; else if (['l', 'r'].includes(centerLower)) expectedKey = 'j'; else expectedKey = '?';
                         const correct = 'j' === expectedKey;
                         stimulusDiv.classList.add('hidden'); noiseOverlay.classList.add('hidden'); touchResponseDiv.classList.add('hidden');
                         results.push({ participantId: participantData.id, age: participantData.age, gender: participantData.gender, trialIndex: currentTrialIndex, stimulus: currentTrial.stimulus_base, centerLetter: currentTrial.centerLetter, congruency: currentTrial.condition_congruency, noise: currentTrial.condition_noise, spacing: currentTrial.condition_spacing, response: 'j', correctKey: expectedKey, correct: correct ? 1 : 0, latency_ms: reactionTime });
                         showFeedback(correct ? "Correct" : "Incorrect");
                         setTimeout(() => { currentTrialIndex++; runTrial(currentTrialIndex); }, FEEDBACK_DURATION + ITI);
                         // --- End Replicated Logic ---
                    };
                    touchBtnF.addEventListener('touchstart', touchFListener, { passive: false });
                    touchBtnJ.addEventListener('touchstart', touchJListener, { passive: false });
                    // <<< --- >>>

                    // Start the response timeout (as before)
                    console.log(`Starting timeout for trial ${trialIndex}`);
                    trialTimeoutId = setTimeout(() => { handleTimeout(currentTrial); }, MAX_RESPONSE_TIME);

                } catch (error) { console.error(`Error setting up trial ${trialIndex}:`, error); }
            }, FIXATION_DURATION);
        }

        // --- Handle Key Press (Modified to also remove touch listeners) ---
        function handleKeyPress(event, trial) {
            const key = event.key.toLowerCase();
            if (key === 'f' || key === 'j') {

                 // Check if already processed (race condition safety)
                 if(results.some(r => r.trialIndex === currentTrialIndex)) {
                     console.log(`Keypress ${key} ignored, result already recorded for trial ${currentTrialIndex}.`);
                     removeTouchListeners(); // Cleanup touch just in case
                     if(keydownListener) document.removeEventListener('keydown', keydownListener); // Cleanup keydown
                     keydownListener = null;
                     if(trialTimeoutId) clearTimeout(trialTimeoutId); // Cleanup timeout
                     trialTimeoutId = null;
                     return;
                  }

                 if (trialTimeoutId) { clearTimeout(trialTimeoutId); trialTimeoutId = null; }
                 else { console.warn(`handleKeyPress called for trial ${currentTrialIndex}, but no active timeoutId found.`); }

                 // Remove *all* listeners now
                 if (keydownListener) { document.removeEventListener('keydown', keydownListener); keydownListener = null; }
                 else { console.warn(`handleKeyPress called for trial ${currentTrialIndex}, but no active keydownListener found.`); return; } // Exit if key listener missing
                 removeTouchListeners(); // <<< Remove touch listeners


                 const reactionTime = performance.now() - stimulusStartTime;
                 let expectedKey; const centerLower = trial.centerLetter.toLowerCase();
                 if (['a', 'k'].includes(centerLower)) expectedKey = 'f'; else if (['l', 'r'].includes(centerLower)) expectedKey = 'j'; else expectedKey = '?';
                 const correct = key === expectedKey;

                 stimulusDiv.classList.add('hidden'); noiseOverlay.classList.add('hidden');
                 touchResponseDiv.classList.add('hidden'); // <<< Hide touch buttons

                 results.push({
                     participantId: participantData.id, age: participantData.age, gender: participantData.gender,
                     trialIndex: currentTrialIndex, stimulus: trial.stimulus_base, centerLetter: trial.centerLetter,
                     congruency: trial.condition_congruency, noise: trial.condition_noise, spacing: trial.condition_spacing,
                     response: key, correctKey: expectedKey, correct: correct ? 1 : 0,
                     latency_ms: reactionTime
                 });

                 showFeedback(correct ? "Correct" : "Incorrect");

                 setTimeout(() => { currentTrialIndex++; runTrial(currentTrialIndex); }, FEEDBACK_DURATION + ITI);
            }
        }

        // --- Handle Timeout (Modified to also remove touch listeners) ---
        function handleTimeout(trial) {
             console.warn(`Timeout occurred for trial ${currentTrialIndex}`);
             trialTimeoutId = null;

             // Check if already processed (race condition safety)
             if(results.some(r => r.trialIndex === currentTrialIndex)) {
                 console.log(`Result for trial ${currentTrialIndex} already recorded, ignoring timeout.`);
                 if (keydownListener) document.removeEventListener('keydown', keydownListener); keydownListener = null;
                 removeTouchListeners();
                 return;
              }

             // Remove remaining listeners
             if (keydownListener) { document.removeEventListener('keydown', keydownListener); keydownListener = null; }
             removeTouchListeners(); // <<< Remove touch listeners

             stimulusDiv.classList.add('hidden'); noiseOverlay.classList.add('hidden');
             touchResponseDiv.classList.add('hidden'); // <<< Hide touch buttons

             results.push({
                 participantId: participantData.id, age: participantData.age, gender: participantData.gender,
                 trialIndex: currentTrialIndex, stimulus: trial.stimulus_base, centerLetter: trial.centerLetter,
                 congruency: trial.condition_congruency, noise: trial.condition_noise, spacing: trial.condition_spacing,
                 response: 'timeout', correctKey: trial.correctKey, correct: 0,
                 latency_ms: -1
             });

             showFeedback("Too Slow");

             setTimeout(() => { currentTrialIndex++; runTrial(currentTrialIndex); }, FEEDBACK_DURATION + ITI);
        }

        // --- Show Feedback (Unaltered) ---
        function showFeedback(message) { /* ... */ }

        // --- End Experiment (Added cleanup) ---
        function endExperiment() {
              // Ensure final trial listeners/timeout are cleared
              if (keydownListener) document.removeEventListener('keydown', keydownListener); keydownListener = null;
              removeTouchListeners();
              if (trialTimeoutId) clearTimeout(trialTimeoutId); trialTimeoutId = null;

              const experimentEndTime = performance.now(); const totalElapsedTime_ms = experimentEndTime - experimentStartTime; console.log("Experiment ended. Calculating metrics...");
              taskDiv.classList.add('hidden'); touchResponseDiv.classList.add('hidden'); // Hide buttons

              // Calculation logic (Unaltered)
              /* ... */
              // Display logic (Unaltered)
              /* ... */
              // Data Prep for Google Sheet (Unaltered)
              /* ... */
              // Call sendDataToSheetGoogle (Unaltered)
              /* ... */
         }

        // --- Data Conversion/Download (Unaltered) ---
        function convertToCSV(dataArray) { /* ... */ }
        function downloadCSVData() { /* ... */ }

        // --- Event Listeners (Unaltered) ---
        continueToInfoBtn.addEventListener('click', () => { /* ... */ });
        infoForm.addEventListener('submit', (event) => { /* ... */ });
        restartBtn.addEventListener('click', () => { /* ... */ });
        developerDataButton.addEventListener('click', downloadCSVData);

        // --- Utility Functions Implementation (Ensure defined) ---
        // (Definitions for shuffleArray, calculateSD, calculateMedian, formatStimulusWithSpacing included earlier)
        // (Full definitions for startExperiment, setupTrials, showFeedback, endExperiment, convertToCSV, downloadCSVData are included above)

    </script>
    <script>
      function sendDataToSheetGoogle(dataPayload) {
        console.log("Attempting to send data via fetch (no-cors):", JSON.stringify(dataPayload).substring(0, 500) + "...");
        fetch("https://script.google.com/macros/s/AKfycbymjapc5sya9P9xXTjDnD5vO7o7ooA0-ORXuMP6to9CcaL_O3MEH87EiALNOlEv_jO5Sw/exec", { // Use your exact deployment URL
          method: "POST",
          headers: { "Content-Type": "application/json", },
          body: JSON.stringify(dataPayload),
          mode: 'no-cors' // Keep no-cors as it's working
        })
        .then(() => { console.log("Data submission fetch initiated (mode: no-cors). Check Google Sheet/Logs."); })
        .catch((error) => { console.error("‚ùå Error initiating fetch:", error); alert("Network error sending data."); });
      }
    </script>
    </body>
</html>
